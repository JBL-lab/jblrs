<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>야구팀 기록 관리 (Firebase 공유)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { color-scheme: light dark; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-bold">⚾️ 야구팀 기록 관리 (Firebase Firestore 공유)</h1>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-8">
    <!-- 팀 추가 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">팀 추가</h2>
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end">
        <label class="flex-1">
          <span class="block text-sm text-gray-600 mb-1">팀 이름</span>
          <input id="teamName" class="w-full rounded-xl border px-3 py-2" placeholder="예) Seoul Sluggers" />
        </label>
        <button id="addTeamBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white">팀 추가</button>
      </div>

      <div class="mt-4">
        <label class="block text-sm text-gray-600 mb-1">등록된 팀</label>
        <select id="teamSelect" class="w-full md:w-80 rounded-xl border px-3 py-2"></select>
      </div>
    </section>

    <!-- 선수 추가 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">선수 추가</h2>
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <label>
          <span class="block text-sm text-gray-600 mb-1">팀 선택</span>
          <select id="playerTeamSelect" class="w-full rounded-xl border px-3 py-2"></select>
        </label>
        <label>
          <span class="block text-sm text-gray-600 mb-1">선수 이름</span>
          <input id="playerName" class="w-full rounded-xl border px-3 py-2" placeholder="예) Kim Minho" />
        </label>
        <button id="addPlayerBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white">선수 추가</button>
      </div>
    </section>

    <!-- 기록 입력 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">기록 입력</h2>
      <div class="grid md:grid-cols-4 gap-3 items-end">
        <label>
          <span class="block text-sm text-gray-600 mb-1">팀</span>
          <select id="recordTeamSelect" class="w-full rounded-xl border px-3 py-2"></select>
        </label>
        <label>
          <span class="block text-sm text-gray-600 mb-1">선수</span>
          <select id="recordPlayerSelect" class="w-full rounded-xl border px-3 py-2"></select>
        </label>
      </div>

      <div class="grid md:grid-cols-5 gap-3 mt-4">
        <label>
          <span class="block text-xs text-gray-600 mb-1">홈런</span>
          <input id="hr" type="number" min="0" value="0" class="w-full rounded-xl border px-3 py-2 text-right" />
        </label>
        <label>
          <span class="block text-xs text-gray-600 mb-1">안타</span>
          <input id="hits" type="number" min="0" value="0" class="w-full rounded-xl border px-3 py-2 text-right" />
        </label>
        <label>
          <span class="block text-xs text-gray-600 mb-1">총 투구 수</span>
          <input id="pitches" type="number" min="0" value="0" class="w-full rounded-xl border px-3 py-2 text-right" />
        </label>
        <label>
          <span class="block text-xs text-gray-600 mb-1">스트라이크</span>
          <input id="strikes" type="number" min="0" value="0" class="w-full rounded-xl border px-3 py-2 text-right" />
        </label>
        <label>
          <span class="block text-xs text-gray-600 mb-1">세이브</span>
          <input id="saves" type="number" min="0" value="0" class="w-full rounded-xl border px-3 py-2 text-right" />
        </label>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="saveRecordBtn" class="rounded-xl px-4 py-2 bg-emerald-600 text-white">기록 저장</button>
        <span id="saveStatus" class="text-sm text-gray-600"></span>
      </div>
    </section>

    <!-- 기록 현황 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">기록 현황</h2>
        <label class="flex items-center gap-2 text-sm">
          <span class="text-gray-600">팀 필터</span>
          <select id="boardTeamFilter" class="rounded-xl border px-3 py-2"></select>
        </label>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="text-left px-3 py-2">선수</th>
              <th class="text-right px-3 py-2">홈런</th>
              <th class="text-right px-3 py-2">안타</th>
              <th class="text-right px-3 py-2">투구 수</th>
              <th class="text-right px-3 py-2">스트라이크</th>
              <th class="text-right px-3 py-2">세이브</th>
              <th class="text-right px-3 py-2">관리</th>
            </tr>
          </thead>
          <tbody id="boardBody" class="divide-y"></tbody>
        </table>
      </div>
    </section>

    <!-- 선수 프로필 -->
    <section id="playerProfile" class="hidden bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">선수 프로필</h2>
      <div id="profileContent" class="space-y-3"></div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">메모</label>
        <textarea id="profileMemo" class="w-full rounded-xl border p-2" rows="4" placeholder="메모를 입력하세요..."></textarea>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="saveMemoBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white">메모 저장</button>
        <button id="closeProfileBtn" class="rounded-xl px-4 py-2 bg-gray-300">닫기</button>
      </div>
    </section>

    <!-- Firebase 설정 가이드 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-2">Firebase 설정 요약</h2>
      <ol class="list-decimal pl-6 text-sm space-y-1 text-gray-700">
        <li>Firebase 콘솔에서 프로젝트 생성 → Firestore 생성</li>
        <li>Authentication 필요 없음</li>
        <li>아래 <code>firebaseConfig</code>에 구성값 붙여넣기</li>
        <li>보안 규칙 테스트용:</li>
      </ol>
      <pre class="bg-gray-900 text-gray-100 p-3 rounded-xl overflow-x-auto text-xs">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</pre>
    </section>
  </main>

  <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-gray-500">
    Firebase Firestore 공유 버전
  </footer>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getFirestore, collection, addDoc, doc,
      updateDoc, deleteDoc, onSnapshot,
      serverTimestamp, increment, query
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7v6Ihvl0DebF5Dlswh0x4mH8qfjgwuE0",
      authDomain: "jblrs-ed141.firebaseapp.com",
      projectId: "jblrs-ed141",
      storageBucket: "jblrs-ed141.firebasestorage.app",
      messagingSenderId: "855919162701",
      appId: "1:855919162701:web:97ec1f81af3c6a63497304",
      measurementId: "G-QJ80TY8EKE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const teamNameInput = document.getElementById('teamName');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const teamSelect = document.getElementById('teamSelect');
    const playerTeamSelect = document.getElementById('playerTeamSelect');
    const playerNameInput = document.getElementById('playerName');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const recordTeamSelect = document.getElementById('recordTeamSelect');
    const recordPlayerSelect = document.getElementById('recordPlayerSelect');
    const hrInput = document.getElementById('hr');
    const hitsInput = document.getElementById('hits');
    const pitchesInput = document.getElementById('pitches');
    const strikesInput = document.getElementById('strikes');
    const savesInput = document.getElementById('saves');
    const saveRecordBtn = document.getElementById('saveRecordBtn');
    const boardTeamFilter = document.getElementById('boardTeamFilter');
    const boardBody = document.getElementById('boardBody');
    const playerProfile = document.getElementById('playerProfile');
    const profileContent = document.getElementById('profileContent');
    const profileMemo = document.getElementById('profileMemo');
    const saveMemoBtn = document.getElementById('saveMemoBtn');
    const closeProfileBtn = document.getElementById('closeProfileBtn');

    let currentProfileId = null;
    let lastSelectedTeamId = localStorage.getItem('lastSelectedTeamId') || '';
    let teamsCache = [];
    let playersCache = [];

    function opt(el, value, label) { const o = document.createElement('option'); o.value=value; o.textContent=label; el.appendChild(o); }
    function clear(el) { while (el.firstChild) el.removeChild(el.firstChild); }
    function toInt(v){ const n=parseInt(v,10); return Number.isFinite(n)?n:0; }

    function subscribeTeams(){
      const q = query(collection(db,'teams'));
      onSnapshot(q, (snap) => {
        teamsCache = snap.docs.map(d => ({ id:d.id, ...d.data() })).sort((a,b)=>a.name.localeCompare(b.name));
        renderTeams();
      });
    }

    function subscribePlayers(){
      const q = query(collection(db,'players'));
      onSnapshot(q, (snap) => {
        playersCache = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        renderBoard();
        const teamId = recordTeamSelect.value;
        if (teamId) populatePlayers(teamId, recordPlayerSelect);
      });
    }

    function renderTeams(){
      [teamSelect, playerTeamSelect, recordTeamSelect, boardTeamFilter].forEach(sel => {
        clear(sel); opt(sel,'','— 팀 선택 —');
        teamsCache.forEach(t => opt(sel, t.id, t.name));
      });
      if (lastSelectedTeamId && teamsCache.some(t=>t.id===lastSelectedTeamId)) {
        playerTeamSelect.value = lastSelectedTeamId;
      }
    }

    async function populatePlayers(teamId, select){
      clear(select); opt(select,'','— 선수 선택 —');
      playersCache.filter(p=>p.teamId===teamId).sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=> opt(select,p.id,p.name));
    }

    function renderBoard(){
      clear(boardBody);
      const filterTeam = boardTeamFilter.value || '';
      playersCache
        .filter(p => !filterTeam || p.teamId===filterTeam)
        .sort((a,b)=>a.name.localeCompare(b.name))
        .forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-3 py-2"><button class="text-blue-600 underline profileBtn" data-id="${p.id}">${escapeHtml(p.name)}</button> <span class="text-xs text-gray-500">(${escapeHtml(teamName(p.teamId))})</span></td>
            <td class="px-3 py-2 text-right">${p.hr||0}</td>
            <td class="px-3 py-2 text-right">${p.hits||0}</td>
            <td class="px-3 py-2 text-right">${p.pitches||0}</td>
            <td class="px-3 py-2 text-right">${p.strikes||0}</td>
            <td class="px-3 py-2 text-right">${p.saves||0}</td>
            <td class="px-3 py-2 text-right"><button class="deleteBtn text-red-600" data-id="${p.id}">삭제</button></td>`;
          boardBody.appendChild(tr);
        });

      document.querySelectorAll('.deleteBtn').forEach(btn => btn.addEventListener('click', async () => {
        await deleteDoc(doc(db,'players', btn.dataset.id));
      }));
      document.querySelectorAll('.profileBtn').forEach(btn => btn.addEventListener('click', () => showProfile(btn.dataset.id)));
    }

    function teamName(id){ const t=teamsCache.find(t=>t.id===id); return t? t.name : '-'; }

    addTeamBtn.addEventListener('click', async () => {
      const name = teamNameInput.value.trim(); if (!name) return;
      await addDoc(collection(db,'teams'), { name, createdAt: serverTimestamp() });
      teamNameInput.value='';
    });

    addPlayerBtn.addEventListener('click', async () => {
      const teamId = playerTeamSelect.value; const name = playerNameInput.value.trim();
      if (!teamId || !name) return;
      await addDoc(collection(db,'players'), { teamId, name, hr:0,hits:0,pitches:0,strikes:0,saves:0, memo:'', createdAt: serverTimestamp() });
      playerNameInput.value='';
      lastSelectedTeamId = teamId; localStorage.setItem('lastSelectedTeamId', teamId);
    });

    recordTeamSelect.addEventListener('change', () => populatePlayers(recordTeamSelect.value, recordPlayerSelect));

    saveRecordBtn.addEventListener('click', async () => {
      const playerId = recordPlayerSelect.value; if (!playerId) return;
      const ref = doc(db,'players', playerId);
      await updateDoc(ref, {
        hr: increment(toInt(hrInput.value)),
        hits: increment(toInt(hitsInput.value)),
        pitches: increment(toInt(pitchesInput.value)),
        strikes: increment(toInt(strikesInput.value)),
        saves: increment(toInt(savesInput.value)),
        updatedAt: serverTimestamp()
      });
      [hrInput,hitsInput,pitchesInput,strikesInput,savesInput].forEach(i=>i.value=0);
      const s = document.getElementById('saveStatus'); s.textContent='저장 완료!'; setTimeout(()=>s.textContent='',1200);
    });

    boardTeamFilter.addEventListener('change', renderBoard);

    function showProfile(id){
      const p = playersCache.find(x=>x.id===id); if (!p) return; currentProfileId=id;
      profileContent.innerHTML = `
        <p><b>이름:</b> ${escapeHtml(p.name)}</p>
        <p><b>팀:</b> ${escapeHtml(teamName(p.teamId))}</p>
        <p class="grid grid-cols-5 gap-2 text-sm"><span><b>HR</b> ${p.hr||0}</span><span><b>H</b> ${p.hits||0}</span><span><b>P</b> ${p.pitches||0}</span><span><b>S</b> ${p.strikes||0}</span><span><b>SV</b> ${p.saves||0}</span></p>`;
      profileMemo.value = p.memo || '';
      playerProfile.classList.remove('hidden'); window.scrollTo({ top: playerProfile.offsetTop-60, behavior:'smooth' });
    }
    saveMemoBtn.addEventListener('click', async () => {
      if (!currentProfileId) return;
      await updateDoc(doc(db,'players', currentProfileId), { memo: profileMemo.value, updatedAt: serverTimestamp() });
    });
    closeProfileBtn.addEventListener('click', ()=> playerProfile.classList.add('hidden'));

    function escapeHtml(str){ return str.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    subscribeTeams(); subscribePlayers();
  </script>
</body>
</html>
