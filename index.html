<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>야구팀 기록 관리 (Firestore 공유)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3">
      <h1 class="text-xl font-bold">⚾️ 야구팀 기록 관리 (Firebase Firestore 공유)</h1>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-8">
    <!-- 팀 추가 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">팀 추가</h2>
      <div class="flex gap-3">
        <input id="teamName" class="flex-1 rounded-xl border px-3 py-2" placeholder="예) Seoul Sluggers" />
        <button id="addTeamBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white">팀 추가</button>
      </div>
      <div class="mt-4">
        <label class="block text-sm text-gray-600 mb-1">등록된 팀</label>
        <select id="teamSelect" class="w-full md:w-80 rounded-xl border px-3 py-2"></select>
      </div>
    </section>

    <!-- 선수 추가 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">선수 추가</h2>
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <select id="playerTeamSelect" class="w-full rounded-xl border px-3 py-2"></select>
        <input id="playerName" class="w-full rounded-xl border px-3 py-2" placeholder="예) Kim Minho" />
        <button id="addPlayerBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white">선수 추가</button>
      </div>
    </section>

    <!-- 기록 입력 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">기록 입력</h2>
      <div class="grid md:grid-cols-4 gap-3">
        <select id="recordTeamSelect" class="w-full rounded-xl border px-3 py-2"></select>
        <select id="recordPlayerSelect" class="w-full rounded-xl border px-3 py-2"></select>
      </div>
      <div class="grid md:grid-cols-5 gap-3 mt-4">
        <input id="hr" type="number" min="0" value="0" class="rounded-xl border px-3 py-2 text-right" placeholder="홈런"/>
        <input id="hits" type="number" min="0" value="0" class="rounded-xl border px-3 py-2 text-right" placeholder="안타"/>
        <input id="pitches" type="number" min="0" value="0" class="rounded-xl border px-3 py-2 text-right" placeholder="투구 수"/>
        <input id="strikes" type="number" min="0" value="0" class="rounded-xl border px-3 py-2 text-right" placeholder="스트라이크"/>
        <input id="saves" type="number" min="0" value="0" class="rounded-xl border px-3 py-2 text-right" placeholder="세이브"/>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="saveRecordBtn" class="rounded-xl px-4 py-2 bg-emerald-600 text-white">기록 저장</button>
        <span id="saveStatus" class="text-sm text-gray-600"></span>
      </div>
    </section>

    <!-- 기록 현황 -->
    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">기록 현황</h2>
        <select id="boardTeamFilter" class="rounded-xl border px-3 py-2"></select>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">선수</th>
              <th class="px-3 py-2 text-right">홈런</th>
              <th class="px-3 py-2 text-right">안타</th>
              <th class="px-3 py-2 text-right">투구 수</th>
              <th class="px-3 py-2 text-right">스트라이크</th>
              <th class="px-3 py-2 text-right">세이브</th>
              <th class="px-3 py-2 text-right">관리</th>
            </tr>
          </thead>
          <tbody id="boardBody" class="divide-y"></tbody>
        </table>
      </div>
    </section>

    <!-- 선수 프로필 -->
    <section id="playerProfile" class="hidden bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-4">선수 프로필</h2>
      <div id="profileContent" class="space-y-2"></div>
      <textarea id="profileMemo" class="w-full rounded-xl border p-2 mt-2" rows="4" placeholder="메모..."></textarea>
      <div class="mt-3 flex gap-2">
        <button id="saveMemoBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white">메모 저장</button>
        <button id="closeProfileBtn" class="rounded-xl px-4 py-2 bg-gray-300">닫기</button>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, increment, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "여기에_본인_apiKey",
      authDomain: "여기에_본인_authDomain",
      projectId: "여기에_본인_projectId",
      storageBucket: "여기에_본인_storageBucket",
      messagingSenderId: "여기에_본인_senderId",
      appId: "여기에_본인_appId"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 요소
    const teamNameInput = document.getElementById('teamName');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const teamSelect = document.getElementById('teamSelect');
    const playerTeamSelect = document.getElementById('playerTeamSelect');
    const playerNameInput = document.getElementById('playerName');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const recordTeamSelect = document.getElementById('recordTeamSelect');
    const recordPlayerSelect = document.getElementById('recordPlayerSelect');
    const hrInput = document.getElementById('hr');
    const hitsInput = document.getElementById('hits');
    const pitchesInput = document.getElementById('pitches');
    const strikesInput = document.getElementById('strikes');
    const savesInput = document.getElementById('saves');
    const saveRecordBtn = document.getElementById('saveRecordBtn');
    const saveStatus = document.getElementById('saveStatus');
    const boardTeamFilter = document.getElementById('boardTeamFilter');
    const boardBody = document.getElementById('boardBody');
    const playerProfile = document.getElementById('playerProfile');
    const profileContent = document.getElementById('profileContent');
    const profileMemo = document.getElementById('profileMemo');
    const saveMemoBtn = document.getElementById('saveMemoBtn');
    const closeProfileBtn = document.getElementById('closeProfileBtn');

    let teamsCache = [];
    let playersCache = [];
    let currentProfileId = null;

    function opt(el, value, label){ const o=document.createElement('option'); o.value=value; o.textContent=label; el.appendChild(o); }
    function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }
    function toInt(v){ const n=parseInt(v,10); return Number.isFinite(n)?n:0; }
    function teamName(id){ const t=teamsCache.find(t=>t.id===id); return t? t.name : '-'; }
    function escapeHtml(str){return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}

    // Teams subscribe
    function subscribeTeams(){
      onSnapshot(collection(db,'teams'), (snap)=>{
        teamsCache = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderTeams();
      });
    }
    // Players subscribe
    function subscribePlayers(){
      onSnapshot(collection(db,'players'), (snap)=>{
        playersCache = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderBoard();
        if(recordTeamSelect.value) populatePlayers(recordTeamSelect.value, recordPlayerSelect);
      });
    }

    function renderTeams(){
      [teamSelect, playerTeamSelect, recordTeamSelect, boardTeamFilter].forEach(sel=>{
        clear(sel); opt(sel,'','— 팀 선택 —'); teamsCache.forEach(t=>opt(sel,t.id,t.name));
      });
    }
    async function populatePlayers(teamId, select){
      clear(select); opt(select,'','— 선수 선택 —');
      playersCache.filter(p=>p.teamId===teamId).forEach(p=>opt(select,p.id,p.name));
    }

    function renderBoard(){
      clear(boardBody);
      const filter = boardTeamFilter.value;
      playersCache.filter(p=>!filter||p.teamId===filter).forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="px-3 py-2"><button class="text-blue-600 underline profileBtn" data-id="${p.id}">${escapeHtml(p.name)}</button> (${escapeHtml(teamName(p.teamId))})</td>
          <td class="px-3 py-2 text-right">${p.hr||0}</td>
          <td class="px-3 py-2 text-right">${p.hits||0}</td>
          <td class="px-3 py-2 text-right">${p.pitches||0}</td>
          <td class="px-3 py-2 text-right">${p.strikes||0}</td>
          <td class="px-3 py-2 text-right">${p.saves||0}</td>
          <td class="px-3 py-2 text-right"><button class="deleteBtn text-red-600" data-id="${p.id}">삭제</button></td>`;
        boardBody.appendChild(tr);
      });
      document.querySelectorAll('.deleteBtn').forEach(btn=>btn.onclick=()=>deleteDoc(doc(db,'players',btn.dataset.id)));
      document.querySelectorAll('.profileBtn').forEach(btn=>btn.onclick=()=>showProfile(btn.dataset.id));
    }

    // Add team
    addTeamBtn.onclick = async ()=>{
      const name=teamNameInput.value.trim(); if(!name) return;
      await addDoc(collection(db,'teams'), { name, createdAt: serverTimestamp() });
      teamNameInput.value=''; // ✅ 입력창 초기화
    };
    // Add player
    addPlayerBtn.onclick = async ()=>{
      const teamId=playerTeamSelect.value; const name=playerNameInput.value.trim();
      if(!teamId||!name) return;
      await addDoc(collection(db,'players'), { teamId,name,hr:0,hits:0,pitches:0,strikes:0,saves:0,memo:'',createdAt: serverTimestamp() });
      playerNameInput.value=''; // ✅ 입력창 초기화
    };

    recordTeamSelect.onchange = ()=>populatePlayers(recordTeamSelect.value,recordPlayerSelect);
    saveRecordBtn.onclick = async ()=>{
      const pid=recordPlayerSelect.value; if(!pid) return;
      await updateDoc(doc(db,'players',pid),{
        hr:increment(toInt(hrInput.value)), hits:increment(toInt(hitsInput.value)),
        pitches:increment(toInt(pitchesInput.value)), strikes:increment(toInt(strikesInput.value)),
        saves:increment(toInt(savesInput.value)), updatedAt: serverTimestamp()
      });
      [hrInput,hitsInput,pitchesInput,strikesInput,savesInput].forEach(i=>i.value=0);
      saveStatus.textContent="저장됨"; setTimeout(()=>saveStatus.textContent='',1200);
    };
    boardTeamFilter.onchange=renderBoard;

    function showProfile(id){
      const p=playersCache.find(x=>x.id===id); if(!p) return; currentProfileId=id;
      profileContent.innerHTML=`<p><b>이름:</b> ${escapeHtml(p.name)}</p><p><b>팀:</b> ${escapeHtml(teamName(p.teamId))}</p>`;
      profileMemo.value=p.memo||'';
      playerProfile.classList.remove('hidden');
    }
    saveMemoBtn.onclick=()=> currentProfileId && updateDoc(doc(db,'players',currentProfileId),{ memo: profileMemo.value, updatedAt: serverTimestamp() });
    closeProfileBtn.onclick=()=>{playerProfile.classList.add('hidden'); currentProfileId=null;};

    subscribeTeams(); subscribePlayers();
  </script>
</body>
</html>
